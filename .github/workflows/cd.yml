name: CD (Lambda)

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: prod-deploy-lambda
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-24.04
    env:
      STACK_NAME: ${{ secrets.LAMBDA_STACK_NAME }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      APP_ID: ${{ secrets.APP_ID }}
      PRIVATE_KEY_BASE64: ${{ secrets.PRIVATE_KEY_BASE64 }}
      WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
      GITHUB_HOST: ${{ secrets.GITHUB_HOST }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Prune dev dependencies
        run: npm prune --omit=dev

      - name: Validate template
        env:
          SAM_CLI_TELEMETRY: 0
        run: sam validate --template-file template.yaml --region "${AWS_REGION}"

      - name: Deploy Lambda
        run: |
          set -euo pipefail
          STACK="${STACK_NAME:-coding-test-review-app}"
          MODEL="${OPENAI_MODEL:-gpt-5-mini}"
          PROVIDER="${AI_PROVIDER:-openai}"
          HOST="${GITHUB_HOST:-}"

          PARAMS=(
            "AppId=$APP_ID"
            "PrivateKeyBase64=$PRIVATE_KEY_BASE64"
            "WebhookSecret=$WEBHOOK_SECRET"
          )

          if [ -n "${OPENAI_API_KEY:-}" ]; then
            PARAMS+=("OpenAiApiKey=$OPENAI_API_KEY")
          fi

          if [ -n "${MODEL:-}" ]; then
            PARAMS+=("OpenAiModel=$MODEL")
          fi

          if [ -n "${PROVIDER:-}" ]; then
            PARAMS+=("AiProvider=$PROVIDER")
          fi

          if [ -n "${HOST:-}" ]; then
            PARAMS+=("GithubHost=$HOST")
          fi

          sam deploy \
            --template-file template.yaml \
            --stack-name "$STACK" \
            --region "$AWS_REGION" \
            --capabilities CAPABILITY_IAM \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --resolve-s3 \
            --parameter-overrides "${PARAMS[@]}"
